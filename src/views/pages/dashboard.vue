<template>
  <div class="main">
    <div class="top-menu clearfix">
      <span>IM</span>
      <span>
        <span v-text="me.userName"></span>&nbsp;&nbsp;|&nbsp;&nbsp;
        <a href="javascript:;" @click="doLogout">退出</a>
      </span>
    </div>
    <ul class="user-list">
      <li v-for="item in online.users" :key="item.id" track-by="$index" @click='chat(item)' :class="{'v-link-active':item.userId==currentActive}">
        {{item.userName}}
        <span class="noread" v-if="item.noRead">{{item.noRead}}</span>
      </li>
    </ul>
    <div class="doc">
      <router-view keep-alive></router-view>
    </div>
  </div>
</template>

<script>
import { mapState, mapGetters, mapActions, mapMutations } from 'vuex'
import * as types from '../../store/mutation-types'

export default {
  name: 'index',
  data () {
    return {
      currentActive: '-1'
    }
  },
  computed: {
    ...mapState({
      me: state => state.users.me,
      online: state => state.users.online,
      socket: ({ base }) => base.socket
    }),
    ...mapGetters({})
  },
  methods: {
    ...mapActions([]),
    ...mapMutations({
      logout: types.LOGOUT,
      updateUsers: types.UPDATE_USERS,
      addUsers: types.ADD_USERS,
      removeUser: types.REMOVE_USER,
      addReceiveMsg: types.ADD_RECEIVE_MSG
    }),
    doLogout () {
      this.socket.disconnect()
      this.logout()
      this.$router.push({ path: '/login' })
    },
    // 监听新用户登录
    listenLogin () {
      const _self = this
      if (_self.socket) {
        _self.socket.on('login', function (o) {
          console.log('[Leo]新用户加入 => ', o.user)
          console.log('[Leo]当前在线用户 => ', o.onlineUsers)
          _self.updateUsers(o.onlineUsers)
        })
      }
    },
    // 监听用户退出
    listenLogout () {
      const _self = this
      if (_self.socket) {
        _self.socket.on('logout', function (o) {
          console.log('[Leo]有用户退出 => ', o)
          _self.removeUser(o.user.userId)
        })
      }
    },
    // 监听消息发送
    listenMsg () {
      const _self = this
      if (_self.socket) {
        _self.socket.on(_self.me.userId, function (obj) {
          console.log('[Leo]有人对我说话 => ', obj.from.userName + ' 对 ' + obj.to.userName + ' 说 ' + obj.content)
          _self.addReceiveMsg(obj)
        })
      }
    },
    chat (user) {
      this.currentActive = user.userId
      this.$router.push({
        name: 'chat',
        params: {
          id: user.userId,
          name: user.userName
        }
      })
    }
  },
  created () {
    if (!this.me.userName) {
      this.$router.push({ name: 'login' })
    }
    this.listenLogin()
    this.listenLogout()
    this.listenMsg()
  }
}
</script>
<style lang="less" scoped>
.main {
  position: relative;
  width: 100vw;
  height: 100vh;
  border: 1px solid #efefef;
  box-shadow: 1px 1px 15px #ccc;
  background-color: #efeff4;
  overflow: hidden;
}

.top-menu {
  background-color: #3d3d3d;
  color: #fff;
  height: 45px;
  width: 100%;
  font-size: 12px;
  line-height: 45px;
  font-size: larger;
  font-family: "Microsoft YaHei UI", "微软雅黑", "Helvetica Neue", Helvetica,
    STHeiTi, sans-serif;

  span:first-child {
    text-align: left;
    margin-left: 10px;

    & + span {
      float: right;
      margin-right: 10px;
    }
  }

  a {
    color: #ffffff;
    text-decoration: none;
  }
}

ul,
li {
  list-style: none;
  padding: 0;
  margin: 0;
}

.user-list {
  position: absolute;
  top: 45px;
  bottom: 0;
  left: 0;
  z-index: 9999999;
  width: 300px;
  overflow-y: auto;
  background-color: #fff;
  box-shadow: 3px 2px 5px #ccc;
  @height: 30 px;
  li {
    padding: 10px;
    line-height: @height;
    cursor: pointer;
    border-bottom: 1px dashed #efefef;

    img {
      float: left;
      width: @height;
      border-radius: 50%;
    }
    & :hover,
    & :active {
      background: #efefef;
    }
    .noread {
      display: inline-block;
      background-color: #f00;
      color: #fff;
      min-width: 20px;
      height: 20px;
      border-radius: 50%;
      font-size: 12px;
      line-height: 20px;
      text-align: center;
    }
  }
}
.doc {
  position: absolute;
  top: 45px;
  bottom: 0;
  left: 300px;
  right: 0;
}
.v-link-active {
  background-color: #efefef;
}
</style>
